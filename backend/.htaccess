# DO NOT REMOVE. CLOUDLINUX PASSENGER CONFIGURATION BEGIN
PassengerAppRoot "/home/ofcngsbz/domains/poligon.live/poligon-app-v3"
PassengerBaseURI "/"
PassengerNodejs "/home/ofcngsbz/nodevenv/domains/poligon.live/poligon-app-v3/20/bin/node"
PassengerAppType node
PassengerStartupFile dist/index.js

# PERFORMANCE OPTIMIZATION - Keep process alive to prevent cold starts
PassengerMinInstances 1
PassengerMaxPoolSize 2
PassengerPoolIdleTime 0
PassengerMaxPreloaderIdleTime 0
# DO NOT REMOVE. CLOUDLINUX PASSENGER CONFIGURATION END

# Force HTTPS
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    # WebSocket Upgrade Check
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteCond %{HTTP:Connection} =Upgrade [NC]
    RewriteRule ^(.*)$ - [E=WEBSOCKET:1,L]
</IfModule>

# WebSocket headers
<IfModule mod_headers.c>
    RequestHeader set X-Forwarded-Proto "https"
    Header always set Connection "Upgrade"
    Header always set Upgrade "websocket"
    
    # Dodatni WebSocket headers
    <If "%{ENV:WEBSOCKET} == '1'">
        RequestHeader set Connection "Upgrade"
        RequestHeader set Upgrade "websocket"
    </If>
    
    # PERFORMANCE - Disable heavy Brotli compression for API routes (use faster gzip)
    SetEnvIf Request_URI "^/api/" no-brotli
</IfModule>

# Produ≈æi timeout za WebSocket konekcije
<IfModule mod_reqtimeout.c>
    RequestReadTimeout handshake=0 header=20-40,MinRate=500 body=20,MinRate=500
</IfModule>

# PERFORMANCE - Optimized Gzip compression for API (faster than Brotli on shared hosting)
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/javascript
    DeflateCompressionLevel 6
</IfModule>

# PERFORMANCE - KeepAlive optimization
SetEnvIf Request_URI "^/socket\.io/" nokeepalive
SetEnvIf Request_URI "^/api/" keepalive=On

# PERFORMANCE - Lower Brotli level if it's still used
<IfModule mod_brotli.c>
    BrotliCompressionLevel 4
    BrotliCompressionMinSize 2048
</IfModule>
